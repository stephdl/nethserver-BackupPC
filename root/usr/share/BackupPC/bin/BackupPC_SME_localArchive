#!/usr/bin/perl

# 	Author: Daniel Berteaud (daniel@firewall-services.com)

#   This program is free software; you can redistribute it and/or modify
#   it under the terms of the GNU General Public License as published by
#   the Free Software Foundation; either version 2 of the License, or
#   (at your option) any later version.
#
#   This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#   GNU General Public License for more details.
#
#   You should have received a copy of the GNU General Public License
#   along with this program; if not, write to the Free Software
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA


use lib "/usr/share/BackupPC/lib";
use BackupPC::SMEarchive;
use strict;


my $logFile = '/tmp/'.genRandName ();


# Sortie erreur standard=fichier de log
open (STDERR, ">$logFile");

my $today = `$path{date} +%F-%kh%M`;
my $check = 1;
# on inscrit la date en haut du fichier log
print STDERR "Starting archive: ".`$path{date}`."\n";

my %opts=();

my %params=(
		'destination'=>"/tmp/",
		'split'=>"0",
		'compress'=>"gzip",
		'cipher'=>'off',
		'key'=>'/etc/BackupPC/archive.key',
		'backupNum'=>"-1",
		'share'=>"*",
		'parity'=>'0',
		'hosts'=>'localhost',
		'sendMailTo'=>'admin',
		'configFile'=>'/etc/BackupPC/localArchive.conf');

# On lance la récupération des paramètre qui retourne le fichier de config à utiliser
$params{configFile} = init($params{configFile});

%params = readConf(\%params);

print STDERR "\nYou have requested to archive these hosts: $params{hosts} to this destination: $params{destination}\n\n";

localArchive($params{hosts},$params{backupNum},$params{share},$params{compress},$params{split},$params{cipher},$params{key},$params{destination});

print STDERR "\n\nArchive finished: ".`$path{date}`."\n";

my $log = `$path{cat} $logFile`;
sendMail($params{sendMailTo},'localArchive',$log);
mvLog('localArchive',$logFile,$today);

exit(0);

